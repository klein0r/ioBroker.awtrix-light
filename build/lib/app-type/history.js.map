{
  "version": 3,
  "sources": ["../../../src/lib/app-type/history.ts"],
  "sourcesContent": ["import { AwtrixLight } from '../../main';\nimport { HistoryApp } from '../adapter-config';\nimport { AwtrixApi } from '../api';\nimport { AppType as AbstractAppType } from './abstract';\n\nexport namespace AppType {\n    export type HistoryOptions = {\n        start: number;\n        end: number;\n        limit: number;\n        aggregate?: 'none' | 'average' | 'min' | 'max' | 'count';\n        step?: number;\n        returnNewestEntries: boolean;\n        ignoreNull: number;\n        removeBorderValues: boolean;\n        ack: boolean;\n    };\n\n    export class History extends AbstractAppType.AbstractApp {\n        private appDefinition: HistoryApp;\n        private isValidSourceInstance: boolean;\n        private isValidObjId: boolean;\n        private refreshTimeout: void | NodeJS.Timeout | null;\n\n        public constructor(apiClient: AwtrixApi.Client, adapter: AwtrixLight, definition: HistoryApp) {\n            super(apiClient, adapter, definition);\n\n            this.appDefinition = definition;\n            this.isValidSourceInstance = false;\n            this.isValidObjId = false;\n            this.refreshTimeout = null;\n        }\n\n        public override async init(): Promise<boolean> {\n            if (this.appDefinition.sourceInstance) {\n                const sourceInstanceObj = await this.adapter.getForeignObjectAsync(`system.adapter.${this.appDefinition.sourceInstance}`);\n\n                if (sourceInstanceObj && sourceInstanceObj.common?.getHistory) {\n                    const sourceInstanceAliveState = await this.adapter.getForeignStateAsync(`system.adapter.${this.appDefinition.sourceInstance}.alive`);\n\n                    if (sourceInstanceAliveState && sourceInstanceAliveState.val) {\n                        this.adapter.log.debug(`[initHistoryApp] Found valid source instance for history data: ${this.appDefinition.sourceInstance}`);\n\n                        this.isValidSourceInstance = true;\n                    } else {\n                        this.adapter.log.warn(`[initHistoryApp] Unable to get history data of \"${this.appDefinition.sourceInstance}\": instance not running (stopped)`);\n                    }\n                } else {\n                    this.adapter.log.warn(`[initHistoryApp] Unable to get history data of \"${this.appDefinition.sourceInstance}\": no valid source for getHistory()`);\n                }\n            }\n\n            if (this.appDefinition.objId) {\n                this.adapter.log.debug(`[initHistoryApp] getting history data for app \"${this.appDefinition.name}\" of \"${this.appDefinition.objId}\" from ${this.appDefinition.sourceInstance}`);\n\n                try {\n                    if (this.isValidSourceInstance) {\n                        const sourceObj = await this.adapter.getForeignObjectAsync(this.appDefinition.objId);\n\n                        if (sourceObj && Object.prototype.hasOwnProperty.call(sourceObj?.common?.custom ?? {}, this.appDefinition.sourceInstance)) {\n                            this.isValidObjId = true;\n                        } else {\n                            this.adapter.log.info(\n                                `[initHistoryApp] Unable to get data for app \"${this.appDefinition.name}\" of \"${this.appDefinition.objId}\": logging is not configured for this object`,\n                            );\n                        }\n                    } else {\n                        this.adapter.log.info(`[initHistoryApp] Unable to get data for app \"${this.appDefinition.name}\" of \"${this.appDefinition.objId}\": source invalid or unavailable`);\n                    }\n                } catch (error) {\n                    this.adapter.log.error(`[initHistoryApp] Unable to get data for app \"${this.appDefinition.name}\" of \"${this.appDefinition.objId}\": ${error}`);\n                }\n            }\n\n            return super.init();\n        }\n\n        public override async refresh(): Promise<boolean> {\n            let refreshed = false;\n\n            if ((await super.refresh()) && this.isValidSourceInstance && this.isValidObjId) {\n                const itemCount = this.appDefinition.icon ? 11 : 16; // can display 11 values with icon or 16 values without icon\n\n                const options: HistoryOptions = {\n                    start: 1,\n                    end: Date.now(),\n                    limit: itemCount,\n                    returnNewestEntries: true,\n                    ignoreNull: 0,\n                    removeBorderValues: true,\n                    ack: true,\n                };\n\n                if (this.appDefinition.mode == 'aggregate') {\n                    options.aggregate = this.appDefinition.aggregation;\n                    options.step = this.appDefinition.step ? this.appDefinition.step * 1000 : 3600;\n                } else {\n                    // mode = last\n                    options.aggregate = 'none';\n                }\n\n                const historyData = await this.adapter.sendToAsync(this.appDefinition.sourceInstance, 'getHistory', {\n                    id: this.appDefinition.objId,\n                    options,\n                });\n                const graphData = (historyData as any)?.result\n                    .filter((state: ioBroker.State) => typeof state.val === 'number' && state.ack)\n                    .map((state: ioBroker.State) => Math.round(state.val as number))\n                    .slice(itemCount * -1);\n\n                this.adapter.log.debug(\n                    `[refreshHistoryApp] Data for app \"${this.appDefinition.name}\" of \"${this.appDefinition.objId}: ${JSON.stringify(historyData)} - filtered: ${JSON.stringify(graphData)}`,\n                );\n\n                if (graphData.length > 0) {\n                    const moreOptions: AwtrixApi.App = {};\n\n                    // Duration\n                    if (this.appDefinition.duration > 0) {\n                        moreOptions.duration = this.appDefinition.duration;\n                    }\n\n                    // Repeat\n                    if (this.appDefinition.repeat > 0) {\n                        moreOptions.repeat = this.appDefinition.repeat;\n                    }\n\n                    // Bar or line graph\n                    if (this.appDefinition.display == 'bar') {\n                        moreOptions.bar = graphData;\n                    } else {\n                        moreOptions.line = graphData;\n                    }\n\n                    await this.apiClient!.appRequestAsync(this.appDefinition.name, {\n                        color: this.appDefinition.lineColor || '#FF0000',\n                        background: this.appDefinition.backgroundColor || '#000000',\n                        autoscale: true,\n                        icon: this.appDefinition.icon,\n                        lifetime: this.adapter.config.historyAppsRefreshInterval + 60, // Remove app if there is no update in configured interval (+ buffer)\n                        pos: this.appDefinition.position,\n                        ...moreOptions,\n                    }).catch((error) => {\n                        this.adapter.log.warn(`(custom?name=${this.appDefinition.name}) Unable to create app \"${this.appDefinition.name}\": ${error}`);\n                    });\n\n                    refreshed = true;\n                } else {\n                    this.adapter.log.debug(`[refreshHistoryApp] Going to remove app \"${this.appDefinition.name}\" (no history data)`);\n\n                    await this.apiClient!.removeAppAsync(this.appDefinition.name).catch((error) => {\n                        this.adapter.log.warn(`[refreshHistoryApp] Unable to remove app \"${this.appDefinition.name}\" (no history data): ${error}`);\n                    });\n                }\n            }\n\n            this.adapter.log.debug(`re-creating history apps timeout (${this.adapter.config.historyAppsRefreshInterval ?? 300} seconds)`);\n            this.refreshTimeout =\n                this.refreshTimeout ||\n                this.adapter.setTimeout(\n                    () => {\n                        this.refreshTimeout = null;\n                        this.refresh();\n                    },\n                    this.adapter.config.historyAppsRefreshInterval * 1000 || 5 * 60 * 1000,\n                );\n\n            return refreshed;\n        }\n\n        public override async unloadAsync(): Promise<void> {\n            if (this.refreshTimeout) {\n                this.adapter.log.debug(`clearing history app timeout for \"${this.getName()}\"`);\n                this.adapter.clearTimeout(this.refreshTimeout);\n            }\n\n            await super.unloadAsync();\n        }\n    }\n}\n"],
  "mappings": "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",
  "names": ["AppType", "AbstractAppType"]
}
